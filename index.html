<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jogo da Velha - Teste</title>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 25px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        
        .section-title {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .cell {
            aspect-ratio: 1/1;
            background: #fff;
            border: 2px solid #3498db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .cell:hover {
            background: #e1f0fa;
        }
        
        .cell.x {
            color: #e74c3c;
        }
        
        .cell.o {
            color: #27ae60;
        }
        
        .game-info {
            text-align: center;
            margin: 20px 0;
            font-size: 18px;
            font-weight: 600;
        }
        
        .token {
            display: inline-block;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 0 5px;
        }
        
        .token-x {
            background: #e74c3c;
            color: white;
        }
        
        .token-o {
            background: #27ae60;
            color: white;
        }
        
        .response {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin-top: 20px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow: auto;
        }
        
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .hidden {
            display: none;
        }
        
        .active-player {
            background: #d4edda;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .game-over {
            background: #f8d7da;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Jogo da Velha - Teste de API</h1>
        
        <!-- Seção de Autenticação -->
        <div class="section">
            <h2 class="section-title">Autenticação</h2>
            <div class="form-group">
                <label for="username">Usuário:</label>
                <input type="text" id="username" placeholder="jogador1">
            </div>
            <div class="form-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" placeholder="senha123">
            </div>
            <button id="btn-login">Login</button>
            <button id="btn-register">Registrar</button>
            
            <div id="auth-response" class="response hidden"></div>
        </div>
        
        <!-- Seção de Jogo -->
        <div class="section" id="game-section" style="display: none;">
            <h2 class="section-title">Jogo da Velha</h2>
            
            <div class="game-info">
                <div id="game-status">Selecione um oponente para começar</div>
            </div>
            
            <div class="game-board" id="game-board">
                <div class="cell" data-index="0"></div>
                <div class="cell" data-index="1"></div>
                <div class="cell" data-index="2"></div>
                <div class="cell" data-index="3"></div>
                <div class="cell" data-index="4"></div>
                <div class="cell" data-index="5"></div>
                <div class="cell" data-index="6"></div>
                <div class="cell" data-index="7"></div>
                <div class="cell" data-index="8"></div>
            </div>
            
            <div class="form-group">
                <label for="opponent">Oponente:</label>
                <input type="text" id="opponent" placeholder="jogador2">
            </div>
            <button id="btn-start-game">Iniciar Novo Jogo</button>
            <button id="btn-load-games">Carregar Meus Jogos</button>
            
            <div id="games-list" class="response hidden"></div>
            <div id="game-response" class="response hidden"></div>
        </div>
        
        <!-- Seção de Estatísticas -->
        <div class="section" id="stats-section" style="display: none;">
            <h2 class="section-title">Estatísticas</h2>
            <button id="btn-get-stats">Obter Minhas Estatísticas</button>
            <button id="btn-get-ranking">Obter Ranking</button>
            
            <div id="stats-response" class="response hidden"></div>
        </div>
    </div>

    <script>
        // Elementos do DOM
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const btnLogin = document.getElementById('btn-login');
        const btnRegister = document.getElementById('btn-register');
        const authResponse = document.getElementById('auth-response');
        const gameSection = document.getElementById('game-section');
        const statsSection = document.getElementById('stats-section');
        const gameStatus = document.getElementById('game-status');
        const gameBoard = document.getElementById('game-board');
        const opponentInput = document.getElementById('opponent');
        const btnStartGame = document.getElementById('btn-start-game');
        const btnLoadGames = document.getElementById('btn-load-games');
        const gamesList = document.getElementById('games-list');
        const gameResponse = document.getElementById('game-response');
        const btnGetStats = document.getElementById('btn-get-stats');
        const btnGetRanking = document.getElementById('btn-get-ranking');
        const statsResponse = document.getElementById('stats-response');
        
        // Variáveis globais
        let currentToken = null;
        let currentGameId = null;
        let currentPlayer = null;
        let currentUsername = null;
        let gameActive = false;
        
        // Configuração da API
        const API_BASE_URL = 'http://localhost:8081/api';
        
        // Event Listeners
        btnLogin.addEventListener('click', handleLogin);
        btnRegister.addEventListener('click', handleRegister);
        btnStartGame.addEventListener('click', startNewGame);
        btnLoadGames.addEventListener('click', loadUserGames);
        btnGetStats.addEventListener('click', getUserStats);
        btnGetRanking.addEventListener('click', getRanking);
        
        document.querySelectorAll('.cell').forEach(cell => {
            cell.addEventListener('click', () => {
                if (gameActive && currentGameId) {
                    const position = parseInt(cell.dataset.index);
                    makeMove(position);
                }
            });
        });
        
        async function handleLogin() {
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            if (!username || !password) {
                showResponse(authResponse, 'Por favor, preencha usuário e senha', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentToken = data.token;
                    currentUsername = username;
                    showResponse(authResponse, `Login bem-sucedido! Token: ${data.token}`, 'success');
                    
                    gameSection.style.display = 'block';
                    statsSection.style.display = 'block';
                    
                    checkPendingGames();
                } else {
                    showResponse(authResponse, `Erro: ${data.message || 'Falha no login'}`, 'error');
                }
            } catch (error) {
                showResponse(authResponse, `Erro: ${error.message}`, 'error');
            }
        }

        async function checkPendingGames() {
            try {
                const response = await fetch(`${API_BASE_URL}/games/pending`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok && data.length > 0) {
                    // Se houver jogos pendentes, carregar o primeiro
                    const pendingGame = data[0];
                    
                    // Perguntar ao usuário se deseja carregar o jogo pendente
                    if (confirm(`Você tem um jogo pendente com ${pendingGame.playerX === currentUsername ? pendingGame.playerO : pendingGame.playerX}. Deseja carregar agora?`)) {
                        loadGame(pendingGame.id);
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar jogos pendentes:', error);
            }
        }
        
        // NOVA FUNÇÃO: Carregar um jogo existente
        async function loadGame(gameId) {
            try {
                const response = await fetch(`${API_BASE_URL}/games/${gameId}`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                const game = await response.json();
                
                if (response.ok) {
                    currentGameId = game.id;
                    gameActive = !game.gameOver;
                    
                    // Determinar se o usuário atual é X ou O
                    currentPlayer = (game.playerX === currentUsername) ? 'X' : 'O';
                    
                    // Atualizar interface
                    renderBoard(game.boardState);
                    
                    // Atualizar status
                    if (game.gameOver) {
                        gameStatus.innerHTML = `Jogo #${game.id} - Encerrado! ${game.winner ? 'Vencedor: ' + game.winner : 'Empate!'}`;
                        gameStatus.classList.add('game-over');
                    } else {
                        const opponent = (game.playerX === currentUsername) 
                            ? game.playerO 
                            : game.playerX;
                            
                        gameStatus.innerHTML = `Jogo #${game.id} - Você é <span class="token token-${currentPlayer.toLowerCase()}">${currentPlayer}</span> vs ${opponent}`;
                    }
                    
                    showResponse(gameResponse, `Jogo carregado com sucesso!`, 'success');
                } else {
                    showResponse(gameResponse, `Erro: ${game.message || 'Falha ao carregar jogo'}`, 'error');
                }
            } catch (error) {
                showResponse(gameResponse, `Erro: ${error.message}`, 'error');
            }
        }

        async function startNewGame() {
            const opponent = opponentInput.value;
            
            if (!opponent) {
                showResponse(gameResponse, 'Por favor, informe o nome do oponente', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/games/start?opponentUsername=${opponent}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentGameId = data.gameId;
                    gameActive = true;
                    
                    const playerMatch = data.message.match(/player (\w+)$/);
                    currentPlayer = playerMatch ? playerMatch[1] : 'X';

                    renderBoard("         ");
                    
                    gameStatus.innerHTML = `Jogo #${data.gameId} - ${data.message}`;
                    
                    showResponse(gameResponse, JSON.stringify(data, null, 2), 'success');
                } else {
                    showResponse(gameResponse, `Erro: ${data.message || 'Falha ao iniciar jogo'}`, 'error');
                }
            } catch (error) {
                showResponse(gameResponse, `Erro: ${error.message}`, 'error');
            }
        }
        
        async function handleRegister() {
            const username = usernameInput.value;
            const password = passwordInput.value;
            
            if (!username || !password) {
                showResponse(authResponse, 'Por favor, preencha usuário e senha', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResponse(authResponse, `Usuário registrado com sucesso! ID: ${data.id}`, 'success');
                } else {
                    showResponse(authResponse, `Erro: ${data.message || 'Falha no registro'}`, 'error');
                }
            } catch (error) {
                showResponse(authResponse, `Erro: ${error.message}`, 'error');
            }
        }
        
        async function startNewGame() {
            const opponent = opponentInput.value;
            
            if (!opponent) {
                showResponse(gameResponse, 'Por favor, informe o nome do oponente', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/games/start?opponentUsername=${opponent}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    currentGameId = data.gameId;  // Alterado de data.id para data.gameId
                    gameActive = true;
                    
                    // Extrair o player da mensagem
                    const playerMatch = data.message.match(/player (\w+)$/);
                    currentPlayer = playerMatch ? playerMatch[1] : 'X';
                    
                    // Inicializar tabuleiro vazio
                    renderBoard("         ");
                    
                    // Atualizar status com o ID do jogo
                    gameStatus.innerHTML = `Jogo #${data.gameId} - ${data.message}`;
                    
                    showResponse(gameResponse, JSON.stringify(data, null, 2), 'success');
                } else {
                    showResponse(gameResponse, `Erro: ${data.message || 'Falha ao iniciar jogo'}`, 'error');
                }
            } catch (error) {
                showResponse(gameResponse, `Erro: ${error.message}`, 'error');
            }
        }
        
        
        async function makeMove(position) {
            try {
                const response = await fetch(`${API_BASE_URL}/games/${currentGameId}/move`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ position })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    renderBoard(data.board);
                    
                    // Atualizar status do jogo
                    if (data.gameOver) {
                        gameStatus.innerHTML = `Jogo encerrado! ${data.winner ? 'Vencedor: ' + data.winner : 'Empate!'}`;
                        gameStatus.classList.add('game-over');
                        gameActive = false;
                        
                        setTimeout(() => {
                            alert(`Jogo encerrado! ${data.winner ? 'Vencedor: ' + data.winner : 'Empate!'}`);
                        }, 500);
                    } else {
                        gameStatus.innerHTML = `Próximo jogador: <span class="active-player">${data.nextPlayer}</span>`;
                        gameStatus.classList.remove('game-over');
                    }
                    
                    showResponse(gameResponse, JSON.stringify(data, null, 2), 'success');
                } else {
                    showResponse(gameResponse, `Erro: ${data.message || 'Falha na jogada'}`, 'error');
                }
            } catch (error) {
                showResponse(gameResponse, `Erro: ${error.message}`, 'error');
            }
        }
        
        async function loadUserGames() {
            try {
                const response = await fetch(`${API_BASE_URL}/games`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    let html = '<h3>Seus Jogos:</h3><ul>';
                    data.forEach(game => {
                        const loadButton = !game.gameOver 
                            ? `<button onclick="loadGame(${game.id})">Carregar Jogo</button>` 
                            : '';
                        
                        html += `<li>
                            <strong>Jogo #${game.id}</strong> - 
                            ${game.playerX} (X) vs ${game.playerO} (O)<br>
                            Estado: ${game.boardState}<br>
                            ${game.gameOver ? `Vencedor: ${game.winner || 'Empate'}` : 'Em andamento'}
                            ${loadButton}
                        </li>`;
                    });
                    html += '</ul>';
                    
                    gamesList.innerHTML = html;
                    gamesList.classList.remove('hidden');
                } else {
                    showResponse(gameResponse, `Erro: ${data.message || 'Falha ao carregar jogos'}`, 'error');
                }
            } catch (error) {
                showResponse(gameResponse, `Erro: ${error.message}`, 'error');
            }
        }


        async function getUserStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/users/me/stats`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const statsHTML = `
                        <h3>Suas Estatísticas:</h3>
                        <p>Usuário: ${data.username}</p>
                        <p>Vitórias: ${data.victories}</p>
                        <p>Derrotas: ${data.defeats}</p>
                        <p>Empates: ${data.draws}</p>
                        <p>Pontuação: ${data.score}</p>
                    `;
                    
                    statsResponse.innerHTML = statsHTML;
                    statsResponse.classList.remove('hidden');
                } else {
                    showResponse(statsResponse, `Erro: ${data.message || 'Falha ao obter estatísticas'}`, 'error');
                }
            } catch (error) {
                showResponse(statsResponse, `Erro: ${error.message}`, 'error');
            }
        }
        
        async function getRanking() {
            try {
                const response = await fetch(`${API_BASE_URL}/users/ranking`);
                const data = await response.json();
                
                if (response.ok) {
                    let html = '<h3>Ranking de Jogadores:</h3><ol>';
                    data.forEach((player, index) => {
                        const rank = index + 1;
                        html += `<li>
                            ${player.username} - 
                            Pontuação: ${player.score}, 
                            Vitórias: ${player.victories}, 
                            Derrotas: ${player.defeats}, 
                            Empates: ${player.draws}
                        </li>`;
                    });
                    html += '</ol>';
                    
                    statsResponse.innerHTML = html;
                    statsResponse.classList.remove('hidden');
                } else {
                    showResponse(statsResponse, `Erro: ${data.message || 'Falha ao obter ranking'}`, 'error');
                }
            } catch (error) {
                showResponse(statsResponse, `Erro: ${error.message}`, 'error');
            }
        }
        
        function renderBoard(boardState) {
            const boardArray = typeof boardState === 'string' 
                ? boardState.split('') 
                : boardState;
            
            const cells = document.querySelectorAll('.cell');
            for (let i = 0; i < 9; i++) {
                const cell = cells[i];
                cell.textContent = '';
                cell.classList.remove('x', 'o');
                
                if (boardArray[i] === 'X') {
                    cell.textContent = 'X';
                    cell.classList.add('x');
                } else if (boardArray[i] === 'O') {
                    cell.textContent = 'O';
                    cell.classList.add('o');
                }
            }
        }
        
        function updateGameStatus(game) {
            const opponent = (game.playerX.username === currentUsername) ? game.playerO.username : game.playerX.username;
            gameStatus.innerHTML = `Jogo #${game.id} - Você é <span class="token token-${currentPlayer.toLowerCase()}">${currentPlayer}</span> vs ${opponent}`;
        }
        
        function updateGameStatusFromState(gameState) {
            if (gameState.gameOver) {
                gameStatus.innerHTML = `Jogo encerrado! ${gameState.winner ? 'Vencedor: ' + gameState.winner : 'Empate!'}`;
                gameStatus.classList.add('game-over');
            } else {
                gameStatus.innerHTML = `Próximo jogador: <span class="active-player">${gameState.nextPlayer}</span>`;
                gameStatus.classList.remove('game-over');
            }
        }
        
        function showResponse(element, message, type = 'success') {
            element.innerHTML = message;
            element.classList.remove('hidden');
            element.classList.remove('status', 'success', 'error');
            element.classList.add('status');
            if (type === 'success') {
                element.classList.add('success');
            } else {
                element.classList.add('error');
            }
        }
        
        usernameInput.value = 'jogador1';
        passwordInput.value = 'senha123';
        opponentInput.value = 'jogador2';
    </script>
</body>
</html>